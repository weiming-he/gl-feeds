From 54e7732a2cb4f9c407af7df563fe8e71a893aba1 Mon Sep 17 00:00:00 2001
From: Jianhui Zhao <zhaojh329@gmail.com>
Date: Wed, 3 Apr 2024 12:12:30 +0800
Subject: [PATCH 1/4] feat(socket): add support set `ipv6_add_membership` and
 `ipv6_drop_membership`

Signed-off-by: Jianhui Zhao <zhaojh329@gmail.com>
---
 socket.c | 15 +++++++++++++++
 1 file changed, 15 insertions(+)

diff --git a/socket.c b/socket.c
index 9c2b57b..f3cd114 100644
--- a/socket.c
+++ b/socket.c
@@ -680,6 +680,19 @@ static int sockopt_set_bindtodevice(struct eco_socket *sock, lua_State *L, struc
     return sockopt_set(sock, L, o, &ifr, sizeof(ifr));
 }
 
+static int sockopt_set_ipv6_membership(struct eco_socket *sock, lua_State *L, struct sock_opt *o)
+{
+    const char *addr = luaL_checkstring(L, 3);
+    struct ipv6_mreq mreq;
+
+    if (inet_pton(AF_INET6, addr, &mreq.ipv6mr_multiaddr) != 1)
+        luaL_argerror(L, 3, "not a valid IPv6 address");
+
+    mreq.ipv6mr_interface = luaL_optinteger(L, 4, 0);
+
+    return sockopt_set(sock, L, o, &mreq, sizeof(mreq));
+}
+
 static struct sock_opt optsets[] = {
     {"reuseaddr", SOL_SOCKET, SO_REUSEADDR, sockopt_set_boolean},
     {"reuseport", SOL_SOCKET, SO_REUSEPORT, sockopt_set_boolean},
@@ -694,6 +707,8 @@ static struct sock_opt optsets[] = {
     {"tcp_fastopen", SOL_TCP, TCP_FASTOPEN, sockopt_set_int},
     {"tcp_nodelay", SOL_TCP, TCP_NODELAY, sockopt_set_boolean},
     {"ipv6_v6only", SOL_IPV6, IPV6_V6ONLY, sockopt_set_boolean},
+    {"ipv6_add_membership", SOL_IPV6, IPV6_ADD_MEMBERSHIP, sockopt_set_ipv6_membership},
+    {"ipv6_drop_membership", SOL_IPV6, IPV6_DROP_MEMBERSHIP, sockopt_set_ipv6_membership},
     {"netlink_add_membership", SOL_NETLINK, NETLINK_ADD_MEMBERSHIP, sockopt_set_int},
     {"netlink_drop_membership", SOL_NETLINK, NETLINK_DROP_MEMBERSHIP, sockopt_set_int},
     {}
-- 
2.34.1

